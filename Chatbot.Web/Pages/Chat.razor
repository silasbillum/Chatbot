@page "/chat"
@inject ChatbotService Chatbot
@using Chatbot.Core.Chatbot
@using Microsoft.AspNetCore.Components.Web

<h3>Chat with the Shop</h3>

<div style="border:1px solid #ccc; padding:10px; height:350px; overflow-y:auto; background:#fafafa; margin-bottom:10px;" @ref="chatBox">
    @foreach (var m in messages)
    {
        <div><strong>@m.Sender:</strong> @m.Text</div>
    }
</div>

<input @bind="currentInput" @bind:event="oninput" placeholder="Type a message..." style="width:70%" @onkeydown="HandleKeyDown" />
<button class="btn btn-primary" @onclick="Send">Send</button>

@code {
    private List<(string Sender,string Text)> messages = new();
    private string currentInput = string.Empty;
    private ElementReference chatBox;
    private string sessionId = Guid.NewGuid().ToString();


    private async Task Send()
    {
        if (string.IsNullOrWhiteSpace(currentInput)) return;
        messages.Add(("You", currentInput));
        messages.Add(("Bot", "Bot is thinking..."));
        StateHasChanged();
        var response = await Chatbot.HandleMessage(sessionId, currentInput);
        // Remove the 'Bot is thinking...' message
        var idx = messages.FindLastIndex(m => m.Sender == "Bot" && m.Text == "Bot is thinking...");
        if (idx != -1) messages.RemoveAt(idx);
        messages.Add(("Bot", response));
        currentInput = string.Empty;
        await Task.Delay(50);
        await chatBox.FocusAsync();
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") await Send();
    }
}
